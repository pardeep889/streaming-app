<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broadcaster</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
</head>
<body>
    <h1>Broadcaster</h1>
    <video autoplay playsinline muted id="video"></video>
    <button id="start-button">Start Broadcast</button>
    <p id="share-link"></p>

    <script>
        const startButton = document.getElementById('start-button');
        const shareLink = document.getElementById('share-link');

        startButton.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById("video").srcObject = stream;

            const peer = new RTCPeerConnection({
                iceServers: [{ urls: "stun:stun.stunprotocol.org" }]
            });

            stream.getTracks().forEach(track => peer.addTrack(track, stream));

            peer.onnegotiationneeded = async () => {
                const offer = await peer.createOffer();
                await peer.setLocalDescription(offer);

                const payload = { sdp: JSON.stringify(peer.localDescription) };
                const { data } = await axios.post('/broadcast', payload);
                const desc = new RTCSessionDescription(data.sdp);
                await peer.setRemoteDescription(desc);

                const link = `http://${window.location.host}/viewer.html?sessionId=${data.sessionId}`;
                console.log(link)
                shareLink.innerHTML = `Share this link: <a href="${link}" target="_blank">${link}</a>`;
            };
        };
    </script>
</body>
</html>
